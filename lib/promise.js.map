{"version":3,"file":"Promise.js","sources":["../src/types.ts","../src/Promise.ts"],"sourcesContent":["export type OnFulfilled = (value?: any) => void;\n\nexport type OnRejected = (reason?: any) => void;\n\nexport type PromiseFn = (resolve: OnFulfilled, reject: OnRejected) => void;\n\nexport enum PromiseState {\n  'PENDING',\n  'FULFILLED',\n  'REJECTED'\n}\n","import {OnFulfilled, OnRejected, PromiseFn, PromiseState} from './types';\n\nexport default class Promise {\n  static resolve(value?: any) {\n    if (value instanceof Promise) {\n      return value;\n    }\n    return new Promise(_resolve => {\n      _resolve(value);\n    })\n  }\n\n  static reject(reason?: any) {\n    return new Promise((_resolve, _reject) => {\n      _reject(reason);\n    })\n  }\n\n  static all(promises: Promise[]) {\n    const results: any[] = [];\n    const len = promises.length;\n    let count = 0;\n\n    return new Promise((_resolve, _reject) => {\n      promises.forEach((promise, index) => {\n        Promise.resolve(promise).then((val) => {\n          count++;\n          results[index] = val;\n          if (count === len) {\n            _resolve(results);\n          }\n        }, (err) => {\n          _reject(err)\n        });\n      });\n    })\n  }\n\n  static race(promises: Promise[]) {\n    return new Promise((_resolve, _reject) => {\n      promises.forEach((promise) => {\n        Promise.resolve(promise).then((val) => {\n          _resolve(val);\n        }, (err) => {\n          _reject(err);\n        })\n      });\n    })\n  }\n\n  value: any;\n  state: PromiseState;\n  private _resolve: OnFulfilled;\n  private _reject: OnRejected;\n  private _resolvedCallbacks: OnFulfilled[];\n  private _rejectedCallbacks: OnRejected[];\n\n  constructor(fn: PromiseFn) {\n    this.value = undefined;\n    this.state = PromiseState.PENDING;\n    this._resolvedCallbacks = [];\n    this._rejectedCallbacks = [];\n\n    this._resolve = (value: any) => {\n      if (value instanceof Promise) {\n        value.then(this._resolve, this._reject);\n      } else {\n        setTimeout(() => {\n          if (this.state === PromiseState.PENDING) {\n            this.state = PromiseState.FULFILLED;\n            this.value = value;\n            this._resolvedCallbacks.forEach(cb => cb());\n          }\n        });\n      }\n    };\n\n    this._reject = (reason: any) => {\n      setTimeout(() => {\n        if (this.state === PromiseState.PENDING) {\n          this.state = PromiseState.REJECTED;\n          this.value = reason;\n          this._rejectedCallbacks.forEach(cb => cb())\n        }\n      })\n    };\n\n    try {\n      fn(this._resolve, this._reject);\n    } catch (e) {\n      this._reject(e);\n    }\n  }\n\n  /**\n   * then\n   * @param onFulfilled\n   * @param onRejected\n   * @see https://promisesaplus.com/#the-then-method\n   */\n  then(onFulfilled?: OnFulfilled, onRejected?: OnRejected): Promise {\n    let promise: Promise;\n\n    if (typeof onFulfilled !== 'function') {\n      onFulfilled = (value) => value;\n    }\n    if (typeof onRejected !== 'function') {\n      onRejected = (reason) => {\n        throw reason;\n      };\n    }\n\n    if (this.state === PromiseState.FULFILLED) {\n      promise = new Promise((resolve, reject) => {\n        setTimeout(() => {\n          try {\n            let x = (onFulfilled as OnFulfilled)(this.value);\n            resolutionProcedure(promise, x, resolve, reject);\n          } catch (e) {\n            reject(e);\n          }\n        })\n      });\n    } else if (this.state === PromiseState.REJECTED) {\n      promise = new Promise((resolve, reject) => {\n        setTimeout(() => {\n          try {\n            let x = (onRejected as OnRejected)(this.value);\n            resolutionProcedure(promise, x, resolve, reject);\n          } catch (e) {\n            reject(e);\n          }\n        })\n      });\n    } else {\n      promise = new Promise((resolve, reject) => {\n        this._resolvedCallbacks.push(() => {\n          try {\n            let x = (onFulfilled as OnFulfilled)(this.value);\n            resolutionProcedure(promise, x, resolve, reject);\n          } catch (e) {\n            reject(e);\n          }\n        });\n\n        this._rejectedCallbacks.push(() => {\n          try {\n            let x = (onRejected as OnRejected)(this.value);\n            resolutionProcedure(promise, x, resolve, reject);\n          } catch (e) {\n            reject(e)\n          }\n        })\n      });\n    }\n\n    return promise;\n  }\n\n  catch(onRejected?: OnRejected) {\n    return this.then(undefined, onRejected);\n  }\n\n  finally(callback: () => void) {\n    return this.then((val) => {\n      return Promise.resolve(callback()).then(() => val);\n    }, (reason) => {\n      return Promise.resolve(callback()).then(() => {\n        throw reason;\n      })\n    })\n  }\n}\n\n/**\n * #2.3 resolution procedure\n * @see https://promisesaplus.com/#the-promise-resolution-procedure\n */\nfunction resolutionProcedure(promise: Promise, x: any, resolve: OnFulfilled, reject: OnRejected) {\n  // #2.3.1\n  if (promise === x) {\n    reject(new TypeError('Error'));\n    return\n  }\n\n  if (x instanceof Promise) {\n    if (x.state === PromiseState.PENDING) {\n      x.then((value) => {\n        resolutionProcedure(promise, value, resolve, reject);\n      }, reject);\n    } else {\n      x.then(resolve, reject);\n    }\n    return;\n  }\n\n  let called = false;\n\n  if (x !== null && (typeof x === 'object' || typeof x === 'function')) {\n    try {\n      let then = x.then;\n      if (typeof then === 'function') {\n        then.call(x, (y: any) => {\n          if (called) return;\n          called = true;\n          resolutionProcedure(promise, y, resolve, reject)\n        }, (e: any) => {\n          if (called) return;\n          called = true;\n          reject(e);\n        });\n      } else {\n        resolve(x);\n      }\n    } catch (e) {\n      if (called) return;\n      called = true;\n      reject(e);\n    }\n  } else {\n    resolve(x);\n  }\n}\n"],"names":[],"mappings":"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"}